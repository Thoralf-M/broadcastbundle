<script>
  import { composeAPI } from "@iota/core";
  import { asTransactionTrytes } from "@iota/transaction-converter";

  let iotanode = "https://node01.iotatoken.nl";
  let txobjectsplaceholder = JSON.stringify(
    {
      hash:
        "OUOEUNSCJEWWIFJRXJCMWLQOMP9SFGG9BNOTVKISKPMZGJJLHZTIEXPYWLRRBLJJGRBKFPTIYMXGQINZI",
      signatureMessageFragment:
        "FCTCBDEAUCXCLDEACCFDXCBDXCHDMDIB9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999",
      address:
        "WEN9FIX9TRINITY9WEN9FIX9TRINITY9WEN9FIX9TRINITY9WEN9FIX9TRINITY9WEN9FIX9TRINITY99",
      value: 0,
      obsoleteTag: "JTINITYFIX99999999999999999",
      timestamp: 1578930785,
      currentIndex: 0,
      lastIndex: 0,
      bundle:
        "GSZTDLIEPLYPUYINKCJHXSKVCKCPIZGHLHNYVFQHPRI9EHNISXOKHUEHFKXECBCUOGJNZXCGJWOYNEXYC",
      trunkTransaction:
        "999999999999999999999999999999999999999999999999999999999999999999999999999999999",
      branchTransaction:
        "999999999999999999999999999999999999999999999999999999999999999999999999999999999",
      tag: "TRINITYFIX99999999999999999",
      attachmentTimestamp: 0,
      attachmentTimestampLowerBound: 0,
      attachmentTimestampUpperBound: 0,
      nonce: "999999999999999999999999999"
    },
    null,
    1
  );
  let link = "https://thetangle.org/transaction/";
  let txobjects;
  let error = "";

  async function sendTxObjects() {
    try {
      let iota = composeAPI({
        provider: iotanode
      });
      let newtxobjects = JSON.parse('['+txobjects+']');
      console.log(newtxobjects);
      let trytes = newtxobjects.map(e => asTransactionTrytes(e));
      console.log(trytes);
      let bundle = await iota.sendTrytes(trytes.reverse(), 3, 14);
      link = "https://thetangle.org/transaction/" + bundle[0].hash;
      console.log("Transfer sent: " + link);
      error = ''
    } catch (e) {
      console.log(e);
      error = e;
    }
  }
</script>

<style>
  input {
    width: 300px;
  }
  textarea {
    width: 90%;
    height: 300px;
  }
  :global(body) {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  :global(html) {
    display: table-cell;
    text-align: center;
    width: 80%;
    margin: 0 auto;
  }
</style>

<input bind:value={iotanode} placeholder="https://node01.iotatoken.nl" />

<textarea bind:value={txobjects} placeholder={txobjectsplaceholder} />

<button on:click={sendTxObjects}>Broadcast bundle</button>

{#if error != ''}
  <span>{error}</span>
{/if}

{#if link.length > 81}
  <a href={link} target="_blank">{link}</a>
{/if}
